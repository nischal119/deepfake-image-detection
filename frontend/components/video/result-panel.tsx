"use client";

import { useRef } from "react";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { ScoreGauge } from "@/components/results/score-gauge";
import { TimelineChart } from "@/components/results/timeline-chart";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Upload, FileDown, ImageIcon } from "lucide-react";
import type { VideoResultResponse } from "@/lib/video-api-client";
import type { Verdict } from "@/lib/types";

interface VideoResultPanelProps {
  result: VideoResultResponse;
  previewUrl?: string | null;
  onNewUpload: () => void;
}

function scoreToVerdict(score: number): Verdict {
  if (score < 0.3) return "likely_real";
  if (score < 0.6) return "inconclusive";
  return "likely_fake";
}

export function VideoResultPanel({
  result,
  previewUrl,
  onNewUpload,
}: VideoResultPanelProps) {
  const printRef = useRef<HTMLDivElement>(null);

  const verdict = scoreToVerdict(result.video_score);

  const timelineData = result.frame_scores.map((f) => ({
    t: f.frame_index,
    score: f.score,
  }));

  const handleDownloadReport = () => {
    const content = printRef.current;
    if (!content) return;
    const printWindow = window.open("", "_blank");
    if (!printWindow) return;
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
        <head><title>Deepfake Report - ${result.filename}</title></head>
        <body style="font-family: system-ui; padding: 2rem; max-width: 800px; margin: 0 auto;">
          <h1>Deepfake Detection Report</h1>
          <p><strong>File:</strong> ${result.filename}</p>
          <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
          <hr/>
          <p><strong>Video Score:</strong> ${(result.video_score * 100).toFixed(1)}%</p>
          <p><strong>Prediction:</strong> ${result.prediction}</p>
          <p><strong>Frames Analyzed:</strong> ${result.num_frames}</p>
          <p><strong>Processing Time:</strong> ${result.processing_time_sec ?? "N/A"}s</p>
          <hr/>
          <h2>Per-Frame Scores</h2>
          <table style="width:100%; border-collapse: collapse;">
            <tr><th>Frame</th><th>Score</th></tr>
            ${result.frame_scores
              .map(
                (f) =>
                  `<tr><td>${f.frame_index}</td><td>${(f.score * 100).toFixed(1)}%</td></tr>`
              )
              .join("")}
          </table>
          <p style="margin-top: 2rem; font-size: 0.875rem; color: #666;">
            Generated by DeepFake Detector. Use File → Print → Save as PDF to save this report.
          </p>
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 250);
  };

  return (
    <div className="space-y-6">
      <Card className="p-6">
        <div ref={printRef}>
          <div className="mb-6">
            <h2 className="mb-1 text-xl font-semibold">Analysis Complete</h2>
            <p className="text-sm text-muted-foreground">{result.filename}</p>
          </div>

          {previewUrl && (
            <div className="mb-6 max-w-md overflow-hidden rounded-lg border border-border/50">
              {/* eslint-disable-next-line jsx-a11y/media-has-caption */}
              <video src={previewUrl} controls className="h-auto w-full" />
            </div>
          )}

          <ScoreGauge score={result.video_score} verdict={verdict} />
        </div>

        <div className="mt-6 flex flex-col gap-3 sm:flex-row">
          <Button onClick={handleDownloadReport} variant="outline">
            <FileDown className="mr-2 h-4 w-4" />
            Download PDF Report
          </Button>
          <Button onClick={onNewUpload}>
            <Upload className="mr-2 h-4 w-4" />
            New Upload
          </Button>
        </div>
      </Card>

      <Card className="p-6">
        <Tabs defaultValue="timeline" className="w-full">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="timeline">Timeline</TabsTrigger>
            <TabsTrigger value="heatmaps">Heatmaps</TabsTrigger>
            <TabsTrigger value="metadata">Metadata</TabsTrigger>
          </TabsList>

          <TabsContent value="timeline" className="space-y-4">
            <div>
              <h3 className="mb-2 font-semibold">Per-Frame Analysis</h3>
              <p className="text-sm text-muted-foreground">
                Fake probability scores across sampled frames.
              </p>
            </div>
            <TimelineChart data={timelineData} xAxisLabel="Frame Index" />
          </TabsContent>

          <TabsContent value="heatmaps" className="space-y-4">
            <div>
              <h3 className="mb-2 font-semibold">Sample Frame Heatmaps</h3>
              <p className="text-sm text-muted-foreground">
                Attention regions for high-scoring frames (placeholders until backend generates heatmaps).
              </p>
            </div>
            <div className="grid grid-cols-2 gap-4 sm:grid-cols-4">
              {result.frame_scores
                .slice()
                .sort((a, b) => b.score - a.score)
                .slice(0, 8)
                .map((f) => (
                  <Card
                    key={f.frame_index}
                    className="overflow-hidden border-border/50 bg-muted/20 p-3"
                  >
                    <div className="relative aspect-video w-full overflow-hidden rounded-md bg-muted">
                      <div
                        className="absolute inset-0 flex items-center justify-center"
                        style={{
                          background: `linear-gradient(135deg, oklch(0.65 0.2 15 / ${f.score}) 0%, transparent 50%)`,
                        }}
                      >
                        <ImageIcon className="h-8 w-8 text-muted-foreground/50" />
                      </div>
                      <div className="absolute bottom-1 left-1 right-1 rounded bg-black/60 px-2 py-1 text-center text-xs text-white">
                        Frame {f.frame_index} · {(f.score * 100).toFixed(0)}%
                      </div>
                    </div>
                  </Card>
                ))}
            </div>
            {result.frame_scores.length === 0 && (
              <p className="text-sm text-muted-foreground">
                No frame data. Heatmap preview available when backend supports it.
              </p>
            )}
          </TabsContent>

          <TabsContent value="metadata" className="space-y-4">
            <div>
              <h3 className="mb-2 font-semibold">Analysis Metadata</h3>
              <p className="text-sm text-muted-foreground">
                Technical details from the detection run
              </p>
            </div>
            <div className="grid grid-cols-2 gap-4 rounded-lg border border-border/50 bg-muted/20 p-4">
              <div>
                <p className="text-sm text-muted-foreground">File Name</p>
                <p className="font-medium">{result.filename}</p>
              </div>
              <div>
                <p className="text-sm text-muted-foreground">Prediction</p>
                <p className="font-medium capitalize">{result.prediction}</p>
              </div>
              <div>
                <p className="text-sm text-muted-foreground">Frames Analyzed</p>
                <p className="font-medium">{result.num_frames}</p>
              </div>
              <div>
                <p className="text-sm text-muted-foreground">Processing Time</p>
                <p className="font-medium">{result.processing_time_sec ?? "N/A"}s</p>
              </div>
            </div>
          </TabsContent>
        </Tabs>
      </Card>
    </div>
  );
}
